{% extends 'cattle/mobile/base.html' %}

{% block title %}{{ title }} - CowTrack モバイル{% endblock %}

{% block extra_css %}
<style>
.mobile-shed-selection {
    background: white;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.mobile-radio-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.mobile-radio-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 8px;
    border: 2px solid transparent;
    transition: all 0.2s;
}

.mobile-radio-item:has(input:checked) {
    background: #e3f2fd;
    border-color: #667eea;
}

.mobile-radio-item input[type="radio"] {
    margin-right: 0.75rem;
    transform: scale(1.2);
}

.mobile-hierarchy-section {
    display: none;
    margin-top: 1rem;
}

.mobile-hierarchy-section.active {
    display: block;
}

.mobile-cow-selection {
    background: white;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: none;
}

.mobile-cow-selection.active {
    display: block;
}

.mobile-cow-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    background: white;
}

.mobile-cow-item {
    padding: 0.75rem;
    border-bottom: 1px solid #e9ecef;
    cursor: pointer;
    transition: background-color 0.2s;
}

.mobile-cow-item:hover {
    background-color: #f8f9fa;
}

.mobile-cow-item.selected {
    background-color: #e3f2fd;
    border-left: 3px solid #667eea;
}

.mobile-cow-item:last-child {
    border-bottom: none;
}

.mobile-search-box {
    margin-bottom: 1rem;
}

.mobile-search-box input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 8px;
    font-size: 1rem;
}

.mobile-selected-cow {
    background: #e8f5e8;
    border: 1px solid #28a745;
    border-radius: 8px;
    padding: 0.75rem;
    margin-top: 1rem;
    display: none;
}

.mobile-selected-cow.active {
    display: block;
}
</style>
{% endblock %}

{% block content %}
<h2>{{ title }}</h2>

<form method="post">
    {% csrf_token %}
    
    <!-- 牛舎選択セクション -->
    <div class="mobile-shed-selection">
        <h3>対象牛舎の選択</h3>
        
        <!-- 1段階目: 牛舎分類 -->
        <div class="mobile-form-group">
            <label>1. 牛舎分類を選択してください</label>
            <div class="mobile-radio-group">
                <div class="mobile-radio-item">
                    <input type="radio" id="category-intro" name="shed_category" value="導入牛舎">
                    <label for="category-intro">導入牛舎</label>
                </div>
                <div class="mobile-radio-item">
                    <input type="radio" id="category-fattening" name="shed_category" value="肥育牛舎">
                    <label for="category-fattening">肥育牛舎</label>
                </div>
                <div class="mobile-radio-item">
                    <input type="radio" id="category-other" name="shed_category" value="その他">
                    <label for="category-other">その他</label>
                </div>
            </div>
        </div>
        
        <!-- 2段階目: 番台・牛舎番号階層プルダウン -->
        <div class="mobile-hierarchy-section" id="shed-hierarchy-section">
            <div class="mobile-form-group">
                <label for="shed-hierarchy-select">2. 番台・牛舎番号を選択してください</label>
                <select id="shed-hierarchy-select" name="shed_code" class="mobile-form-control">
                    <option value="">番台・牛舎番号を選択してください</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- 対象牛選択セクション -->
    <div class="mobile-cow-selection" id="cow-selection-section">
        <h3>対象牛の選択</h3>
        <div class="mobile-search-box">
            <input type="text" id="cow-search" placeholder="牛番号で検索..." class="mobile-form-control">
        </div>
        <div class="mobile-cow-list" id="cow-list"></div>
        <div class="mobile-selected-cow" id="selected-cow-display">
            <strong>選択された牛:</strong> <span id="selected-cow-text"></span>
        </div>
    </div>
    
    <input type="hidden" id="selected-cow-id" name="cow" value="">
    
    <!-- その他のフォームフィールド -->
    <div class="mobile-form">
        <div class="mobile-form-group">
            <label for="{{ form.treatment_date.id_for_label }}">治療日時</label>
            {{ form.treatment_date }}
            {% if form.treatment_date.errors %}
                <div style="color: #dc3545; font-size: 0.9rem; margin-top: 0.25rem;">{{ form.treatment_date.errors }}</div>
            {% endif %}
        </div>
        
        <div class="mobile-form-group">
            <label for="{{ form.diagnosis.id_for_label }}">診断</label>
            {{ form.diagnosis }}
            {% if form.diagnosis.errors %}
                <div style="color: #dc3545; font-size: 0.9rem; margin-top: 0.25rem;">{{ form.diagnosis.errors }}</div>
            {% endif %}
        </div>
        
        <div class="mobile-form-group">
            <label for="{{ form.body_temperature.id_for_label }}">体温</label>
            {{ form.body_temperature }}
            {% if form.body_temperature.errors %}
                <div style="color: #dc3545; font-size: 0.9rem; margin-top: 0.25rem;">{{ form.body_temperature.errors }}</div>
            {% endif %}
        </div>
        
        <div class="mobile-form-group">
            <label for="{{ form.follow_up_days.id_for_label }}">経過観察日数</label>
            {{ form.follow_up_days }}
            {% if form.follow_up_days.errors %}
                <div style="color: #dc3545; font-size: 0.9rem; margin-top: 0.25rem;">{{ form.follow_up_days.errors }}</div>
            {% endif %}
        </div>
        
        <div class="mobile-form-group">
            <label for="{{ form.note.id_for_label }}">備考</label>
            {{ form.note }}
            {% if form.note.errors %}
                <div style="color: #dc3545; font-size: 0.9rem; margin-top: 0.25rem;">{{ form.note.errors }}</div>
            {% endif %}
        </div>
    </div>
    
    <button type="submit" class="mobile-btn success">{{ submit_text }}</button>
    <a href="{% url 'cattle:mobile_treatment_list' %}" class="mobile-btn secondary">キャンセル</a>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const shedHierarchy = {{ shed_hierarchy|safe }};
    const categoryRadios = document.querySelectorAll('input[name="shed_category"]');
    const hierarchySection = document.getElementById('shed-hierarchy-section');
    const hierarchySelect = document.getElementById('shed-hierarchy-select');
    const cowSelectionSection = document.getElementById('cow-selection-section');
    const cowList = document.getElementById('cow-list');
    const cowSearch = document.getElementById('cow-search');
    const selectedCowId = document.getElementById('selected-cow-id');
    const selectedCowDisplay = document.getElementById('selected-cow-display');
    const selectedCowText = document.getElementById('selected-cow-text');
    let allCows = [];
    let filteredCows = [];
    
    // 牛舎分類の選択
    categoryRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            const category = this.value;
            
            // 階層セクションをリセット
            hierarchySelect.innerHTML = '<option value="">番台・牛舎番号を選択してください</option>';
            cowSelectionSection.classList.remove('active');
            selectedCowDisplay.classList.remove('active');
            selectedCowId.value = '';
            
            if (shedHierarchy[category]) {
                hierarchySection.classList.add('active');
                
                if (category === 'その他') {
                    // その他の場合は直接牛舎番号を追加
                    if (Array.isArray(shedHierarchy[category])) {
                        shedHierarchy[category].forEach(shedCode => {
                            const option = document.createElement('option');
                            option.value = shedCode;
                            option.textContent = `その他 - ${shedCode}`;
                            hierarchySelect.appendChild(option);
                        });
                    }
                } else {
                    // 導入牛舎・肥育牛舎の場合は階層構造を処理
                    Object.keys(shedHierarchy[category]).forEach(subcat => {
                        const subcatOption = document.createElement('option');
                        subcatOption.value = '';
                        subcatOption.textContent = `--- ${subcat} ---`;
                        subcatOption.disabled = true;
                        hierarchySelect.appendChild(subcatOption);
                        
                        if (Array.isArray(shedHierarchy[category][subcat])) {
                            shedHierarchy[category][subcat].forEach(shedCode => {
                                const option = document.createElement('option');
                                option.value = shedCode;
                                option.textContent = `${subcat} - ${shedCode}`;
                                hierarchySelect.appendChild(option);
                            });
                        }
                    });
                }
            } else {
                hierarchySection.classList.remove('active');
            }
        });
    });
    
    // 階層プルダウンの選択
    hierarchySelect.addEventListener('change', function() {
        const shedCode = this.value;
        if (shedCode) {
            loadCows(shedCode);
        } else {
            cowSelectionSection.classList.remove('active');
            selectedCowDisplay.classList.remove('active');
            selectedCowId.value = '';
        }
    });
    
    // 牛の検索
    cowSearch.addEventListener('input', function() {
        filterCows(this.value);
    });
    
    // 牛を読み込む
    function loadCows(shedCode) {
        fetch(`/api/cows-by-shed/?shed_code=${encodeURIComponent(shedCode)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                allCows = data.cows;
                filteredCows = allCows;
                displayCows();
                cowSelectionSection.classList.add('active');
            })
            .catch(error => {
                console.error('Error loading cows:', error);
            });
    }
    
    // 牛を表示
    function displayCows() {
        cowList.innerHTML = '';
        filteredCows.forEach(cow => {
            const cowItem = document.createElement('div');
            cowItem.className = 'mobile-cow-item';
            cowItem.textContent = cow.display_name;
            cowItem.dataset.cowId = cow.id;
            cowItem.dataset.cowName = cow.display_name;
            cowItem.addEventListener('click', function() {
                selectCow(cow.id, cow.display_name);
            });
            cowList.appendChild(cowItem);
        });
    }
    
    // 牛を検索
    function filterCows(searchTerm) {
        filteredCows = allCows.filter(cow => 
            cow.display_name.toLowerCase().includes(searchTerm.toLowerCase())
        );
        displayCows();
    }
    
    // 牛を選択
    function selectCow(cowId, cowName) {
        document.querySelectorAll('.mobile-cow-item').forEach(item => {
            item.classList.remove('selected');
        });
        const selectedItem = document.querySelector(`[data-cow-id="${cowId}"]`);
        if (selectedItem) {
            selectedItem.classList.add('selected');
        }
        selectedCowId.value = cowId;
        selectedCowText.textContent = cowName;
        selectedCowDisplay.classList.add('active');
    }
});
</script>
{% endblock %} 