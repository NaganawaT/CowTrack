# Excel一括登録機能

## 概要

牛の治療履歴管理システムに、Excelファイルから牛のデータを一括で登録する機能を追加しました。この機能により、大量の牛データを効率的にシステムに取り込むことができます。

## 機能

### 1. Webインターフェース

#### アクセス方法
1. 管理画面にログイン
2. 管理ダッシュボードから「Excel一括登録」をクリック
3. Excelファイルをアップロードして一括登録を実行

#### 対応ファイル形式
- `.xlsx` (Excel 2007以降)
- `.xls` (Excel 97-2003)

#### 必要な列
- **牛番号**（必須）: 10桁の個体識別番号
- **牛舎番号**（必須）: 牛舎の番号
- **導入日**（任意）: YYYY/MM/DD形式
- **性別**（任意）: "castrated"（去勢）または"female"（メス）
- **導入元地域**（任意）: 北海道、曽於、関、飛騨、自家など
- **ステータス**（任意）: "active"（活動中）または"inactive"（非活動）

#### オプション設定
- **重複データをスキップ**: 既に登録されている牛番号のデータをスキップ
- **既存データを更新**: 既に登録されている牛番号のデータを更新

### 2. コマンドライン機能

#### 手動実行
```bash
# 基本的な使用方法
python manage.py import_cows_from_excel

# オプション付き
python manage.py import_cows_from_excel \
    --directory=./excel_imports \
    --skip-duplicates \
    --update-existing \
    --move-processed
```

#### オプション
- `--directory`: Excelファイルが格納されているディレクトリ（デフォルト: ./excel_imports）
- `--skip-duplicates`: 重複データをスキップ（デフォルト: True）
- `--update-existing`: 既存データを更新（デフォルト: False）
- `--move-processed`: 処理済みファイルを移動（デフォルト: True）

### 3. 自動更新機能

#### cronジョブ設定
```bash
# cronジョブを設定
python manage.py setup_cron

# カスタムスケジュールで設定
python manage.py setup_cron --schedule="0 */4 * * *" --directory=./excel_imports
```

#### 手動設定
```bash
# crontabを編集
crontab -e

# 以下の行を追加（6時間ごとに実行）
0 */6 * * * cd /path/to/project && python manage.py import_cows_from_excel --directory=./excel_imports >> ./logs/excel_import.log 2>&1
```

## 使用方法

### 1. Excelファイルの準備

以下の形式でExcelファイルを作成してください：

| 牛番号 | 牛舎番号 | 導入日 | 性別 | 導入元地域 | ステータス |
|--------|----------|--------|------|------------|------------|
| 1234567890 | A001 | 2024/01/15 | female | 北海道 | active |
| 1234567891 | A002 | 2024/01/16 | castrated | 曽於 | active |

### 2. Webインターフェースでの登録

1. 管理画面にログイン
2. 「Excel一括登録」をクリック
3. Excelファイルを選択
4. オプションを設定
5. 「一括登録を実行」をクリック

### 3. コマンドラインでの登録

```bash
# ディレクトリを作成
mkdir excel_imports

# Excelファイルを配置
# excel_imports/cows_data.xlsx

# 一括登録を実行
python manage.py import_cows_from_excel
```

### 4. 自動更新の設定

```bash
# cronジョブを設定（6時間ごと）
python manage.py setup_cron

# ディレクトリ構造
excel_imports/
├── cows_data.xlsx          # 処理待ちファイル
├── processed/              # 処理済みファイル
│   └── cows_data.xlsx
└── error/                  # エラーファイル
    └── error_data.xlsx
```

## エラーハンドリング

### 1. ファイル形式エラー
- サポートされていないファイル形式の場合
- ファイルが破損している場合

### 2. データ形式エラー
- 必須列が不足している場合
- データ形式が正しくない場合
- 日付形式が正しくない場合

### 3. 重複エラー
- 既に登録されている牛番号の場合（スキップオプションが無効の場合）

## ログ機能

### 1. Webインターフェース
- 処理結果がメッセージとして表示
- 成功、警告、エラーメッセージを色分けして表示

### 2. コマンドライン
- 詳細な処理ログを表示
- 各ファイルの処理結果を個別に表示

### 3. 自動更新
- ログファイルに処理結果を記録
- エラーが発生した場合もログに記録

## セキュリティ

### 1. ファイル検証
- ファイル形式の検証
- ファイルサイズの制限
- 悪意のあるファイルの検出

### 2. データ検証
- 必須項目の存在確認
- データ形式の検証
- 重複データの検出

### 3. アクセス制御
- 管理者のみがアクセス可能
- ログイン認証が必要

## 今後の拡張予定

### 1. 機能拡張
- 治療履歴の一括登録
- 餌観察記録の一括登録
- 獣医師情報の一括登録

### 2. 自動化の強化
- より柔軟なスケジュール設定
- メール通知機能
- 処理結果の詳細レポート

### 3. ユーザビリティの向上
- ドラッグ&ドロップ対応
- リアルタイムプレビュー
- 進捗表示機能

## トラブルシューティング

### 1. よくある問題

#### ファイルがアップロードできない
- ファイルサイズを確認
- ファイル形式を確認
- ファイルが破損していないか確認

#### データが登録されない
- 必須列が正しく設定されているか確認
- データ形式が正しいか確認
- 重複データの設定を確認

#### 自動更新が動作しない
- cronジョブが正しく設定されているか確認
- ログファイルを確認
- ディレクトリの権限を確認

### 2. ログの確認

```bash
# ログファイルを確認
tail -f ./logs/excel_import.log

# エラーの詳細を確認
grep "ERROR" ./logs/excel_import.log
```

### 3. 手動での確認

```bash
# データベースの確認
python manage.py shell
>>> from cattle.models import Cow
>>> Cow.objects.count()
>>> Cow.objects.all()[:5]
```

## まとめ

Excel一括登録機能により、大量の牛データを効率的にシステムに取り込むことができます。Webインターフェースとコマンドラインの両方に対応し、自動更新機能も備えているため、運用の効率化に大きく貢献します。

将来的には、より多くのデータタイプに対応し、より高度な自動化機能を追加する予定です。 