# 牛番号並び替え改善レポート

## 概要
餌観察記録登録画面で対象牛を選択する際、牛個体識別番号（10桁）の文字列順でソートされていたため、下5桁の牛番号の数値順で並んでいませんでした。これを修正し、現場で使用する牛番号順でソートするように改善しました。

## 用語の定義
- **牛個体識別番号**: 10桁の数字（例: 1234567890）
- **牛番号**: 牛個体識別番号の下5桁（例: 67890）

## 問題の概要
- **問題**: 牛個体識別番号が文字列として扱われ、文字列順でソートされていた
- **影響**: 現場で使用する下5桁の牛番号順で並んでいないため、目的の牛を見つけにくい
- **対象画面**: 餌観察記録関連画面、牛一覧画面、治療履歴登録画面

## 改善内容

### 1. 下5桁の牛番号の数値順ソート実装
- **問題**: 牛個体識別番号が文字列として扱われ、文字列順でソートされていた
- **解決**: 下5桁の牛番号を数値として扱い、数値順でソートするように修正

### 2. 適用画面
- **餌観察記録登録画面**: 対象牛選択プルダウン
- **餌観察記録編集画面**: 対象牛選択プルダウン
- **餌観察記録一覧画面**: 検索フィルターの対象牛選択
- **牛一覧画面**: 牛番号列の並び順
- **治療履歴登録画面**: 対象牛選択プルダウン

## 技術的実装

### バックエンド（Django）
```python
# 下5桁の牛番号を数値としてソートするための関数
def sort_cows_by_last5_digits(cows):
    cows_list = list(cows)
    cows_list.sort(key=lambda cow: int(cow.cow_number[-5:]) if cow.cow_number.isdigit() and len(cow.cow_number) >= 5 else float('inf'))
    return cows_list

# APIエンドポイントでの適用例
def cows_by_shed(request):
    shed_code = request.GET.get('shed_code')
    cows = Cow.objects.filter(shed_code=shed_code, status='active')
    
    # 下5桁の牛番号を数値としてソート
    cows_list = list(cows)
    cows_list.sort(key=lambda cow: int(cow.cow_number[-5:]) if cow.cow_number.isdigit() and len(cow.cow_number) >= 5 else float('inf'))
    
    cow_list = [
        {
            'id': cow.id,
            'label': f"{cow.shed_code}｜{cow.intake_date.month if cow.intake_date else '-'}｜{cow.origin_region[:1]}｜{cow.cow_number[-5:]}"
        }
        for cow in cows_list
    ]
    return JsonResponse({'cows': cow_list})
```

### フォームでの適用例
```python
# TreatmentFormでの適用
def __init__(self, *args, **kwargs):
    super().__init__(*args, **kwargs)
    # 活動中の牛のみを選択肢に表示し、下5桁の牛番号を数値順で並び替え
    cows = Cow.objects.filter(status='active')
    cows_list = list(cows)
    cows_list.sort(key=lambda cow: int(cow.cow_number[-5:]) if cow.cow_number.isdigit() and len(cow.cow_number) >= 5 else float('inf'))
    self.fields['cow'].queryset = cows_list
```

## 改善効果

### ソート結果の比較

#### 改善前（牛個体識別番号の文字列順）
```
牛個体識別番号: 1476872092 (牛番号: 72092)
牛個体識別番号: 1361802418 (牛番号: 02418)
牛個体識別番号: 1591315351 (牛番号: 15351)
牛個体識別番号: 1404543162 (牛番号: 43162)
牛個体識別番号: 1656349222 (牛番号: 49222)
```

#### 改善後（下5桁の牛番号の数値順）
```
牛個体識別番号: 1361802418 (牛番号: 02418)
牛個体識別番号: 1591315351 (牛番号: 15351)
牛個体識別番号: 1404543162 (牛番号: 43162)
牛個体識別番号: 1656349222 (牛番号: 49222)
牛個体識別番号: 1476872092 (牛番号: 72092)
```

### ユーザビリティの向上
- **現場での使いやすさ**: 現場で使用する下5桁の牛番号順で並ぶため、期待通りの順序で表示
- **検索効率の向上**: 目的の牛番号を素早く見つけられる
- **一貫性の確保**: 全画面で統一された並び順

## 実装詳細

### ソートロジック
```python
# 下5桁の牛番号の数値順ソートのロジック
cows_list.sort(key=lambda cow: int(cow.cow_number[-5:]) if cow.cow_number.isdigit() and len(cow.cow_number) >= 5 else float('inf'))
```

- `cow.cow_number[-5:]`: 牛個体識別番号の下5桁を取得
- `int(cow.cow_number[-5:])`: 下5桁を数値に変換
- `if cow.cow_number.isdigit() and len(cow.cow_number) >= 5`: 数字のみで5桁以上の場合のみ変換
- `else float('inf')`: 条件を満たさない場合は無限大として最後に配置

### エラーハンドリング
- 牛個体識別番号が数字以外の場合でもエラーにならないよう配慮
- 5桁未満の場合は無限大として最後に配置
- 特殊な牛個体識別番号（文字列）は最後に配置

## 適用箇所一覧

### 1. APIエンドポイント
- `cows_by_shed`: 餌観察記録登録画面の対象牛選択

### 2. ビュー
- `FeedingObservationListView.get_context_data`: 餌観察記録一覧画面の検索フィルター
- `cow_list`: 牛一覧画面

### 3. フォーム
- `TreatmentForm.__init__`: 治療履歴登録画面の対象牛選択
- `FeedingObservationForm.__init__`: 餌観察記録登録画面の対象牛選択

## テスト結果

### テストデータ
```
牛個体識別番号: 1476872092 (牛番号: 72092)
牛個体識別番号: 1361802418 (牛番号: 02418)
牛個体識別番号: 1591315351 (牛番号: 15351)
牛個体識別番号: 1404543162 (牛番号: 43162)
牛個体識別番号: 1656349222 (牛番号: 49222)
```

### ソート結果
```
修正前の並び順（牛個体識別番号順）:
  1476872092 (下5桁: 72092)
  1361802418 (下5桁: 02418)
  1591315351 (下5桁: 15351)
  1404543162 (下5桁: 43162)
  1656349222 (下5桁: 49222)

修正後の並び順（下5桁の牛番号順）:
  1361802418 (下5桁: 02418)
  1591315351 (下5桁: 15351)
  1404543162 (下5桁: 43162)
  1656349222 (下5桁: 49222)
  1476872092 (下5桁: 72092)
```

## 今後の拡張案
1. **データベースレベルでのソート**: パフォーマンス向上のため、データベース側で下5桁の数値順ソートを実装
2. **設定による切り替え**: ユーザー設定でソート方法を選択可能（牛個体識別番号順 vs 牛番号順）
3. **キャッシュ機能**: ソート結果をキャッシュしてパフォーマンス向上
4. **並び替えオプション**: 牛舎番号順、導入日順など複数の並び替えオプション

## まとめ
下5桁の牛番号の並び替え改善により、餌観察記録登録画面での対象牛選択が現場の実務に即した使いやすさになり、ユーザーの作業効率が向上しました。現場で実際に使用する牛番号順でソートされるため、目的の牛を素早く見つけることができるようになりました。 